# Alembic Migrations для BFF Service

Этот каталог содержит миграции базы данных для Analysis DB (BFF Service), управляемые с помощью Alembic.

## Структура

```
alembic/
├── versions/           # Файлы миграций
│   └── 001_add_route_name_to_analysis_tasks.py
├── env.py             # Конфигурация окружения Alembic
├── script.py.mako     # Шаблон для новых миграций
└── README.md          # Этот файл
```

## Использование

### Применить миграции

Из директории `bff-service`:

```bash
# Применить все непримененные миграции
alembic upgrade head

# Применить конкретную миграцию
alembic upgrade 001

# Откатить на одну миграцию назад
alembic downgrade -1

# Откатить все миграции
alembic downgrade base
```

### Создать новую миграцию

```bash
# Автогенерация миграции на основе изменений в моделях
alembic revision --autogenerate -m "описание изменений"

# Создать пустую миграцию
alembic revision -m "описание изменений"
```

### Проверить текущее состояние

```bash
# Показать текущую версию БД
alembic current

# Показать историю миграций
alembic history

# Показать, какие миграции будут применены
alembic upgrade head --sql
```

## Docker

Для применения миграций в Docker-контейнере:

```bash
# Войти в контейнер
docker exec -it bff-service bash

# Применить миграции
cd /app
alembic upgrade head
```

## Текущие миграции

- **001** - Добавление поля `route_name` в таблицу `analysis_tasks`
  - Добавляет колонку `route_name VARCHAR(250)` для хранения названия маршрута
  - Nullable: да (необязательное поле)
  - Включает комментарий к колонке

## Важные замечания

1. **Перед применением миграций** убедитесь, что база данных создана и доступна
2. **В production** всегда делайте бэкап БД перед применением миграций
3. **Автогенерация** может не обнаружить все изменения (особенно изменения в enum, индексах)
4. **Проверяйте** сгенерированные миграции перед применением

## Переменные окружения

Миграции используют настройки из `app/core/config.py`:
- `ANALYSIS_DATABASE_URL` - URL подключения к БД

Убедитесь, что переменная окружения установлена корректно.

## Troubleshooting

### Ошибка "Can't locate revision identified by '...'"

Это означает, что таблица `alembic_version` не синхронизирована с файлами миграций.

Решение:
```bash
# Пометить текущую версию вручную
alembic stamp head
```

### Ошибка "Target database is not up to date"

База данных находится в неопределенном состоянии.

Решение:
```bash
# Проверить текущую версию
alembic current

# Применить недостающие миграции
alembic upgrade head
```

### База данных создана через Base.metadata.create_all()

Если таблицы были созданы напрямую через SQLAlchemy, нужно пометить БД как актуальную:

```bash
# Пометить БД как находящуюся на последней версии
alembic stamp head
```

